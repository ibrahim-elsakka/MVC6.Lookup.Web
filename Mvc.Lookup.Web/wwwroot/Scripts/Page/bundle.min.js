/*!
 * Mvc.Lookup 3.2.1
 * https://github.com/NonFactors/MVC6.Lookup
 *
 * Copyright © NonFactors
 *
 * Licensed under the terms of the MIT License
 * http://www.opensource.org/licenses/mit-license.php
 */
var MvcLookupFilter=function(){function n(n){var t=n.group.dataset;this.lookup=n;this.sort=t.sort||"";this.order=t.order||"";this.search=t.search||"";this.page=parseInt(t.page)||0;this.rows=parseInt(t.rows)||20;this.additional=(t.filters||"").split(",").filter(Boolean)}return n.prototype={formUrl:function(n){for(var e,f,r=encodeURIComponent,s=this.lookup.url.split("?")[0],o=this.lookup.url.split("?")[1],i=this.lookup.extend({ids:[],checkIds:[],selected:[]},this,n),u="?"+(o?o+"&":"")+"search="+r(i.search),t=0;t<i.additional.length;t++)for(e=document.querySelectorAll('[name="'+i.additional[t]+'"]'),f=0;f<e.length;f++)u+="&"+r(i.additional[t])+"="+r(e[f].value);for(t=0;t<i.selected.length;t++)u+="&selected="+r(i.selected[t].Id);for(t=0;t<i.checkIds.length;t++)u+="&checkIds="+r(i.checkIds[t].value);for(t=0;t<i.ids.length;t++)u+="&ids="+r(i.ids[t].value);return u+="&sort="+r(i.sort)+"&order="+r(i.order)+"&rows="+r(i.rows)+"&page="+r(i.page)+"&_="+Date.now(),s+u}},n}(),MvcLookupDialog=function(){function n(n){var t=this,i=document.getElementById(n.group.dataset.dialog||"MvcLookupDialog");t.lookup=n;t.element=i;t.title=n.group.dataset.title||"";t.options={preserveSearch:!0,rows:{min:1,max:99},openDelay:100};t.overlay=new MvcLookupOverlay(this);t.table=i.querySelector("table");t.tableHead=i.querySelector("thead");t.tableBody=i.querySelector("tbody");t.rows=i.querySelector(".mvc-lookup-rows");t.pager=i.querySelector(".mvc-lookup-pager");t.header=i.querySelector(".mvc-lookup-title");t.search=i.querySelector(".mvc-lookup-search");t.selector=i.querySelector(".mvc-lookup-selector");t.closeButton=i.querySelector(".mvc-lookup-close");t.error=i.querySelector(".mvc-lookup-dialog-error");t.loader=i.querySelector(".mvc-lookup-dialog-loader")}return n.prototype={open:function(){var t=this,i=t.lookup.filter;n.prototype.current=this;t.error.style.display="none";t.loader.style.display="none";t.header.innerText=t.title;t.selected=t.lookup.selected.slice();t.rows.value=t.limitRows(i.rows);t.error.innerHTML=t.lookup.lang.error;t.search.placeholder=t.lookup.lang.search;t.selector.style.display=t.lookup.multi?"":"none";i.search=t.options.preserveSearch?i.search:"";t.selector.innerText=t.lookup.lang.select.replace("{0}",t.lookup.selected.length);t.bind();t.refresh();t.search.value=i.search;setTimeout(function(){t.isLoading&&(t.loader.style.opacity=1,t.loader.style.display="");t.overlay.show()},t.options.openDelay)},close:function(){var t=n.prototype.current;t.lookup.group.classList.remove("mvc-lookup-error");t.lookup.select(t.selected,!0);t.lookup.search.focus();t.lookup.stopLoading();t.overlay.hide();n.prototype.current=null},refresh:function(){var n=this,t;n.isLoading=!0;n.error.style.opacity=0;n.error.style.display="";n.loader.style.display="";t=setTimeout(function(){n.loader.style.opacity=1},n.lookup.options.loadingDelay);n.lookup.startLoading({selected:n.selected},function(i){n.isLoading=!1;clearTimeout(t);n.render(i)},function(){n.isLoading=!1;clearTimeout(t);n.render()})},render:function(n){var t=this;t.pager.innerHTML="";t.tableBody.innerHTML="";t.tableHead.innerHTML="";t.loader.style.opacity=0;setTimeout(function(){t.loader.style.display="none"},t.lookup.options.loadingDelay);n?(t.error.style.display="none",t.renderHeader(n.columns),t.renderBody(n.columns,n.rows),t.renderFooter(n.filteredRows)):t.error.style.opacity=1},renderHeader:function(n){for(var i=document.createElement("tr"),t=0;t<n.length;t++)n[t].hidden||i.appendChild(this.createHeaderColumn(n[t]));i.appendChild(document.createElement("th"));this.tableHead.appendChild(i)},renderBody:function(n,t){var u,f,h,l,i,e,a,r,o,s,c;for(t.length||(u=document.createElement("td"),f=document.createElement("tr"),u.innerHTML=this.lookup.lang.noData,u.colSpan=n.length+1,f.className="mvc-lookup-empty",this.tableBody.appendChild(f),f.appendChild(u)),h=!1,l=t.length&&this.lookup.indexOf(this.selected,t[0].Id)>=0,i=0;i<t.length;i++){for(e=this.createDataRow(t[i]),a=document.createElement("td"),r=0;r<n.length;r++)n[r].hidden||(o=document.createElement("td"),o.className=n[r].cssClass||"",o.innerText=t[i][n[r].key]||"",e.appendChild(o));e.appendChild(a);!h&&l&&this.lookup.indexOf(this.selected,t[i].Id)<0&&(s=document.createElement("tr"),c=document.createElement("td"),s.className="mvc-lookup-split",c.colSpan=n.length+1,this.tableBody.appendChild(s),s.appendChild(c),h=!0);this.tableBody.appendChild(e)}},renderFooter:function(n){var t=this,i=t.lookup.filter,r,f,u;if(t.totalRows=n+t.selected.length,r=Math.ceil(n/i.rows),i.page=t.limitPage(i.page),r){for(f=Math.floor(i.page/4)*4,i.page&&4<r&&(t.renderPage("&laquo",0),t.renderPage("&lsaquo;",i.page-1)),u=f;u<r&&u<f+4;u++)t.renderPage(u+1,u);4<r&&i.page<r-1&&(t.renderPage("&rsaquo;",i.page+1),t.renderPage("&raquo;",r-1))}else i.page=0,t.renderPage(1,0)},renderPage:function(n,t){var i=document.createElement("button"),u=this.lookup.filter,r;i.type="button";r=this;u.page==t&&(i.className="active");i.innerHTML=n;i.addEventListener("click",function(){u.page=r.limitPage(t);r.refresh()});r.pager.appendChild(i)},createHeaderColumn:function(n){var i=document.createElement("th"),t=this.lookup.filter,r=this;return n.cssClass&&i.classList.add(n.cssClass),t.sort==n.key&&i.classList.add("mvc-lookup-"+t.order.toLowerCase()),i.innerText=n.header||"",i.addEventListener("click",function(){t.order=t.sort==n.key&&t.order=="Asc"?"Desc":"Asc";t.sort=n.key;r.refresh()}),i},createDataRow:function(n){var t=this,i=this.lookup,r=document.createElement("tr");return i.indexOf(t.selected,n.Id)>=0&&(r.className="selected"),r.addEventListener("click",function(){if(window.getSelection().isCollapsed){var r=i.indexOf(t.selected,n.Id);r>=0?i.multi&&(t.selected.splice(r,1),this.classList.remove("selected")):(i.multi?t.selected.push(n):t.selected=[n],this.classList.add("selected"));i.multi?t.selector.innerText=t.lookup.lang.select.replace("{0}",t.selected.length):t.close()}}),r},limitPage:function(n){return Math.max(0,Math.min(n,Math.ceil((this.totalRows-this.selected.length)/this.lookup.filter.rows)-1))},limitRows:function(n){return n=Math.max(this.options.rows.min,Math.min(parseInt(n),this.options.rows.max)),isNaN(n)?this.lookup.filter.rows:n},bind:function(){var n=this;n.selector.addEventListener("click",n.close);n.rows.addEventListener("change",n.rowsChanged);n.closeButton.addEventListener("click",n.close);n.search.addEventListener("keyup",n.searchChanged)},rowsChanged:function(){var t=n.prototype.current,i=t.limitRows(this.value);this.value=i;t.lookup.filter.rows!=i&&(t.lookup.filter.rows=i,t.lookup.filter.page=0,t.refresh())},searchChanged:function(t){var r=this,i=n.prototype.current;i.lookup.stopLoading();clearTimeout(i.searching);i.searching=setTimeout(function(){(i.lookup.filter.search!=r.value||t.keyCode==13)&&(i.lookup.filter.search=r.value,i.lookup.filter.page=0,i.refresh())},i.lookup.options.searchDelay)}},n}(),MvcLookupOverlay=function(){function n(n){this.element=this.findOverlay(n.element);this.dialog=n;this.bind()}return n.prototype={findOverlay:function(n){var t=n;if(!t)throw new Error("Lookup dialog element was not found.");while(t&&!t.classList.contains("mvc-lookup-overlay"))t=t.parentElement;if(!t)throw new Error("Lookup dialog has to be inside a mvc-lookup-overlay.");return t},show:function(){var n=document.body.getBoundingClientRect(),t,i;n.left+n.right<window.innerWidth&&(t=window.innerWidth-document.body.clientWidth,i=parseFloat(getComputedStyle(document.body).paddingRight),document.body.style.paddingRight=i+t+"px");document.body.classList.add("mvc-lookup-open");this.element.style.display="block"},hide:function(){document.body.classList.remove("mvc-lookup-open");document.body.style.paddingRight="";this.element.style.display=""},bind:function(){this.element.addEventListener("click",this.onClick);document.addEventListener("keydown",this.onKeyDown)},onClick:function(n){var t=(n.target||n.srcElement).classList;(t.contains("mvc-lookup-overlay")||t.contains("mvc-lookup-wrapper"))&&MvcLookupDialog.prototype.current.close()},onKeyDown:function(n){n.which==27&&MvcLookupDialog.prototype.current&&MvcLookupDialog.prototype.current.close()}},n}(),MvcLookupAutocomplete=function(){function n(n){this.lookup=n;this.activeItem=null;this.element=document.createElement("ul");this.element.className="mvc-lookup-autocomplete";this.options={minLength:1,rows:20,sort:n.filter.sort,order:n.filter.order}}return n.prototype={search:function(n){var t=this,i=t.lookup;i.stopLoading();clearTimeout(t.searching);t.searching=setTimeout(function(){if(n.length<t.options.minLength||i.readonly){t.hide();return}i.startLoading({search:n,rows:t.options.rows,page:0,sort:t.options.sort,order:t.options.order},function(n){var r,u;for(t.hide(),n=n.rows.filter(function(n){return!i.multi||i.indexOf(i.selected,n.Id)<0}),r=0;r<n.length;r++)u=document.createElement("li"),u.innerText=n[r].Label,u.dataset.id=n[r].Id,t.element.appendChild(u),t.bind(u,[n[r]]),r==0&&(t.activeItem=u,u.classList.add("active"));n.length&&t.show()})},t.lookup.options.searchDelay)},previous:function(){if(!this.element.parentElement){this.search(this.lookup.search.value);return}this.activeItem.classList.remove("active");this.activeItem=this.activeItem.previousElementSibling||this.element.lastElementChild;this.activeItem.classList.add("active")},next:function(){if(!this.element.parentElement){this.search(this.lookup.search.value);return}this.activeItem.classList.remove("active");this.activeItem=this.activeItem.nextElementSibling||this.element.firstElementChild;this.activeItem.classList.add("active")},show:function(){var n=this.lookup.search.getBoundingClientRect();this.element.style.left=n.left+window.pageXOffset+"px";this.element.style.top=n.top+n.height+window.pageYOffset+"px";document.body.appendChild(this.element)},hide:function(){this.activeItem=null;this.element.innerHTML="";this.element.parentElement&&document.body.removeChild(this.element)},bind:function(n,t){var i=this,r=i.lookup;n.addEventListener("mousedown",function(n){n.preventDefault()});n.addEventListener("click",function(){r.multi?r.select(r.selected.concat(t),!0):r.select(t,!0);r.stopLoading();i.hide()});n.addEventListener("mouseenter",function(){i.activeItem&&i.activeItem.classList.remove("active");this.classList.add("active");i.activeItem=this})}},n}(),MvcLookup=function(){function n(n,t){var i=this,r=i.findLookup(n);if(r.dataset.id)return i.instances[parseInt(r.dataset.id)].set(t||{});i.items=[];i.events={};i.group=r;i.selected=[];i.for=r.dataset.for;i.url=r.dataset.url;i.multi=r.dataset.multi=="True";i.group.dataset.id=i.instances.length;i.readonly=r.dataset.readonly=="True";i.options={searchDelay:500,loadingDelay:300};i.search=r.querySelector(".mvc-lookup-input");i.browser=r.querySelector(".mvc-lookup-browser");i.control=r.querySelector(".mvc-lookup-control");i.error=r.querySelector(".mvc-lookup-control-error");i.valueContainer=r.querySelector(".mvc-lookup-values");i.values=i.valueContainer.querySelectorAll(".mvc-lookup-value");i.instances.push(i);i.filter=new MvcLookupFilter(i);i.dialog=new MvcLookupDialog(i);i.autocomplete=new MvcLookupAutocomplete(i);i.set(t||{});i.reload(!1);i.cleanUp();i.bind()}return n.prototype={instances:[],lang:{search:"Search...",select:"Select ({0})",noData:"No data found",error:"Error while retrieving records"},findLookup:function(n){var t=n;if(!t)throw new Error("Lookup element was not specified.");while(t&&!t.classList.contains("mvc-lookup"))t=t.parentElement;if(!t)throw new Error("Lookup can only be created from within mvc-lookup structure.");return t},extend:function(){for(var n,i={},t=0;t<arguments.length;t++)for(n in arguments[t])arguments[t].hasOwnProperty(n)&&(i[n]=Object.prototype.toString.call(i[n])=="[object Object]"?this.extend(i[n],arguments[t][n]):arguments[t][n]);return i},set:function(n){return this.options.loadingDelay=n.loadingDelay==null?this.options.loadingDelay:n.loadingDelay,this.options.searchDelay=n.searchDelay==null?this.options.searchDelay:n.searchDelay,this.autocomplete.options=this.extend(this.autocomplete.options,n.autocomplete),this.setReadonly(n.readonly==null?this.readonly:n.readonly),this.dialog.options=this.extend(this.dialog.options,n.dialog),this.events=this.extend(this.events,n.events),this},setReadonly:function(n){var t=this;t.readonly=n;n?(t.search.tabIndex=-1,t.search.readOnly=!0,t.group.classList.add("mvc-lookup-readonly"),t.browser&&(t.browser.tabIndex=-1)):(t.search.removeAttribute("readonly"),t.search.removeAttribute("tabindex"),t.group.classList.remove("mvc-lookup-readonly"),t.browser&&t.browser.removeAttribute("tabindex"));t.resize()},browse:function(){this.readonly||(this.browser&&this.browser.blur(),this.dialog.open())},reload:function(n){var r=[],t=this,u=t.search.value,i=[].filter.call(t.values,function(n){return n.value});i.length?t.startLoading({ids:i,rows:i.length,page:0},function(u){for(var e,f=0;f<i.length;f++)e=t.indexOf(u.rows,i[f].value),e>=0&&r.push(u.rows[e]);t.select(r,n)}):(t.stopLoading(),t.select(r,n),!t.multi&&t.search.name&&(t.search.value=u))},select:function(n,t){var i=this,r,u;if(t=t==null||t,!i.events.select||i.events.select.call(i,n,t)!==!1){if(t&&n.length==i.selected.length)for(t=!1,r=0;r<n.length&&!t;r++)t=n[r].Id!=i.selected[r].Id;i.selected=n;i.multi?(i.search.value="",i.valueContainer.innerHTML="",i.items.forEach(function(n){n.parentElement.removeChild(n)}),i.items=i.createSelectedItems(n),i.items.forEach(function(n){i.control.insertBefore(n,i.search)}),i.values=i.createValues(n),i.values.forEach(function(n){i.valueContainer.appendChild(n)}),i.resize()):n.length?(i.values[0].value=n[0].Id,i.search.value=n[0].Label):(i.values[0].value="",i.search.value="");t&&(typeof Event=="function"?u=new Event("change"):(u=document.createEvent("Event"),u.initEvent("change",!0,!0)),i.search.dispatchEvent(u),[].forEach.call(i.values,function(n){n.dispatchEvent(u)}))}},selectFirst:function(n){var t=this;t.startLoading({search:"",rows:1,page:0},function(i){t.select(i.rows,n)})},selectSingle:function(n){var t=this;t.startLoading({search:"",rows:2,page:0},function(i){i.rows.length==1?t.select(i.rows,n):t.select([],n)})},createSelectedItems:function(n){for(var t,i,u=[],r=0;r<n.length;r++)t=document.createElement("button"),t.className="mvc-lookup-deselect",t.innerText="×",t.type="button",i=document.createElement("div"),i.innerText=n[r].Label||"",i.className="mvc-lookup-item",i.appendChild(t),u.push(i),this.bindDeselect(t,n[r].Id);return u},createValues:function(n){for(var t,r=[],i=0;i<n.length;i++)t=document.createElement("input"),t.className="mvc-lookup-value",t.value=n[i].Id,t.type="hidden",t.name=this.for,r.push(t);return r},startLoading:function(n,t,i){var r=this;r.stopLoading();r.loading=setTimeout(function(){r.autocomplete.hide();r.group.classList.add("mvc-lookup-loading")},r.options.loadingDelay);r.group.classList.remove("mvc-lookup-error");r.request=new XMLHttpRequest;r.request.open("GET",r.filter.formUrl(n),!0);r.request.setRequestHeader("X-Requested-With","XMLHttpRequest");r.request.onload=function(){200<=r.request.status&&r.request.status<400?(r.stopLoading(),t(JSON.parse(r.request.responseText))):r.request.onerror()};r.request.onerror=function(){r.group.classList.add("mvc-lookup-error");r.error.title=r.lang.error;r.autocomplete.hide();r.stopLoading();i&&i()};r.request.send()},stopLoading:function(){this.request&&this.request.readyState!=4&&this.request.abort();clearTimeout(this.loading);this.group.classList.remove("mvc-lookup-loading")},bindDeselect:function(n,t){var i=this;n.addEventListener("click",function(){i.select(i.selected.filter(function(n){return n.Id!=t}),!0);i.search.focus()})},indexOf:function(n,t){for(var i=0;i<n.length;i++)if(n[i].Id==t)return i;return-1},cleanUp:function(){var n=this.group.dataset;delete n.readonly;delete n.filters;delete n.dialog;delete n.search;delete n.multi;delete n.order;delete n.title;delete n.page;delete n.rows;delete n.sort;delete n.url},resize:function(){var n=this,i;if(n.items.length){var t=getComputedStyle(n.control),r=n.control.clientWidth,u=n.items[n.items.length-1];r-=parseFloat(t.paddingLeft)+parseFloat(t.paddingRight);i=Math.floor(r-u.offsetLeft-u.offsetWidth);i>r/3?(t=getComputedStyle(n.search),i-=parseFloat(t.marginLeft)+parseFloat(t.marginRight)+4,n.search.style.width=i+"px"):n.search.style.width=""}else n.search.style.width=""},bind:function(){var n=this,t,r,i;for(window.addEventListener("resize",function(){n.resize()}),n.search.addEventListener("focus",function(){n.group.classList.add("mvc-lookup-focus")}),n.search.addEventListener("blur",function(){n.stopLoading();n.autocomplete.hide();n.group.classList.remove("mvc-lookup-focus");var t=this.value;!n.multi&&n.selected.length?n.selected[0].Label!=this.value&&n.select([],!0):this.value="";!n.multi&&n.search.name&&(this.value=t)}),n.search.addEventListener("keydown",function(t){if(t.which==8&&!this.value.length&&n.selected.length)n.select(n.selected.slice(0,-1),!0);else if(t.which==38)t.preventDefault(),n.autocomplete.previous();else if(t.which==40)t.preventDefault(),n.autocomplete.next();else if(t.which==13&&n.autocomplete.activeItem){t.preventDefault();var i;typeof Event=="function"?i=new Event("click"):(i=document.createEvent("Event"),i.initEvent("click",!0,!0));n.autocomplete.activeItem.dispatchEvent(i)}}),n.search.addEventListener("input",function(){this.value.length||n.multi||!n.selected.length||(n.autocomplete.hide(),n.select([],!0));n.autocomplete.search(this.value)}),n.browser&&n.browser.addEventListener("click",function(){n.browse()}),t=0;t<n.filter.additional.length;t++)for(r=document.querySelectorAll('[name="'+n.filter.additional[t]+'"]'),i=0;i<r.length;i++)r[i].addEventListener("change",function(){if((n.stopLoading(),n.filter.page=0,!n.events.filterChange||n.events.filterChange.call(n,this)!==!1)&&n.selected.length){var i=[],t=[].filter.call(n.values,function(n){return n.value});n.startLoading({checkIds:t,rows:t.length},function(r){for(var f,u=0;u<t.length;u++)f=n.indexOf(r.rows,t[u].value),f>=0&&i.push(r.rows[f]);n.select(i,!0)},function(){n.select(i,!0)})}})}},n}();(function(){document.getElementById("SearchInput").addEventListener("keyup",function(){for(var u,f,t,e,i,r=document.querySelectorAll(".sidebar li"),o=this.value.toLowerCase().split(" "),n=0;n<r.length;n++){for(u=!0,f=r[n].innerText.toLowerCase().split(" "),t=0;t<o.length;t++){for(e=!1,i=0;i<f.length;i++)f[i].indexOf(o[t])>=0&&(e=!0);e||(u=!1)}r[n].style.display=u?"":"none"}});[].forEach.call(document.getElementsByClassName("mvc-lookup"),function(n){new MvcLookup(n)})})();